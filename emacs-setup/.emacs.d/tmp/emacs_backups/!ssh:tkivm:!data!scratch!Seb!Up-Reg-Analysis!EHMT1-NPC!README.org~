#+TITLE:Upstream Regulatory Analysis: EHMT1 KOLF/NPC 
#+AUTHOR: Sebastian Rauschert, PhD
#+email: Sebastian.Rauschert@telethonkids.org.au
#+INFOJS_OPT: 
#+BABEL: :session *R* :cache yes :results output graphics :exports both :tangle yes 
-----
* Upstream regulatory analysis for EHMT1 KOLF and NPC 

** Overview of this project folder
   
#+begin_src sh :results output :exports results
  echo "Directory structure:"
  tree -d .
#+end_src

#+RESULTS:
#+begin_example
Directory structure:
.
├── applications
├── code
├── data
│   ├── bedfiles
│   ├── DE-list
│   ├── fasta
│   └── gtf
├── output
│   ├── ame-out
│   ├── dreme-out
│   └── meme-out
└── singularity

12 directories
#+end_example

** How to inspect what was done
As this project folder is a fully reproducible one, implemented with ~datalad~, the individual steps performed can be inspected by typing the following in the base of the project folder:
#+BEGIN_SRC 
git log
#+END_SRC

this shows the full list of actions under taken on the dataset.

** Add data

*** Genome ~.gtf~ file

In order to perform upstream regulatory analysis on the significantly up- and downregulated genes, we need to extract the coordinates for the Ensembl Gene Ids from the gencode ~.gtf~ file. 
So first, we download the ~.gtf~ file into the folder ~data > gtf~. 

#+BEGIN_SRC 
datalad download-url '
#+END_SRC

*** ~GRCh38.primary_assembly.genome.fa~

I just copied this file over from my home directory, so it is part of the project folder now.

** Add software (containers) required

For this analysis we require three pieces of software: 

- R   
- bedtools  
- memesuite


*** ~R~

I have created a singularity container for R, that by default can be used as an executable, holding all necessary requirements. It works as if one would use the command ~Rscript~. The image file for this is in the singularity folder (~singularity-R~).

#+BEGIN_SRC 
singularity build singularity-R.simg singularity-R
#+END_SRC

*** ~bedtools
~
~bedtools~ can be downloaded as an executable :

#+BEGIN_SRC 
datalad download-url 'https://github.com/arq5x/bedtools2/releases/download/v2.30.0/bedtools.static.binary' -O applications/bedtools
#+END_SRC

*** ~memesuite~

The ~memesuite~ is available as a docker container, but since we are using singularity here, I created the image as a singularity container:

#+BEGIN_SRC 
singularity build meme.simg docker://memesuite/memesuite
#+END_SRC

This container is located in the singularity folder.

** Analysis steps

*** Identify the DE genes
This was done outside of this folder. We used the ~R~ package ~DESeq2~ to perform DE analysis.

*** Create bedfiles for up- and downregulated gene list

Extract the genomic locations from the ~.gtf~ file:  

#+BEGIN_SRC 
cat data/gtf/gencode.v29.annotation.gtf | grep -E  'ENSG00000214548|ENSG00000129824|ENSG00000218739|ENSG00000204065|ENSG00000250337|ENSG00000137871|ENSG00000225746|ENSG00000134709|ENSG00000172183|ENSG00000064218|ENSG00000041982|ENSG00000259436|ENSG00000131620|ENSG00000223403|ENSG00000028277|ENSG00000181722|ENSG00000131584|ENSG00000121749|ENSG00000138083|ENSG00000147571|ENSG00000164418|ENSG00000135457|ENSG00000165891|ENSG00000152583|ENSG00000169126|ENSG00000166407|ENSG00000101098|ENSG00000152910|ENSG00000166073|ENSG00000198208|ENSG00000259439|ENSG00000261678|ENSG00000077327|ENSG00000090932|ENSG00000167178|ENSG00000148704|ENSG00000008710|ENSG00000103034|ENSG00000114923|ENSG00000159409|ENSG00000134115|ENSG00000229415|ENSG00000127903|ENSG00000158555|ENSG00000118193|ENSG00000234602|ENSG00000171130|ENSG00000088325|ENSG00000119547|ENSG00000178233|ENSG00000119866|ENSG00000198794|ENSG00000180938|ENSG00000114554|ENSG00000172020|ENSG00000188573|ENSG00000131080|ENSG00000106948|ENSG00000107338|ENSG00000090097|ENSG00000182272|ENSG00000055118|ENSG00000147642|ENSG00000140287|ENSG00000185090|ENSG00000143850|ENSG00000162344|ENSG00000105649|ENSG00000162599|ENSG00000163071|ENSG00000099814|ENSG00000231609|ENSG00000124208|ENSG00000006128|ENSG00000162039|ENSG00000066735|ENSG00000124194|ENSG00000121653|ENSG00000112742|ENSG00000213626|ENSG00000128482|ENSG00000008853|ENSG00000118407|ENSG00000105642|ENSG00000162722|ENSG00000160716|ENSG00000162188|ENSG00000111783|ENSG00000258399|ENSG00000139438|ENSG00000103723|ENSG00000008118|ENSG00000134245|ENSG00000188931|ENSG00000089199|ENSG00000205927|ENSG00000129159|ENSG00000113328|ENSG00000116852|ENSG00000011332|ENSG00000133878|ENSG00000088340|ENSG00000006377|ENSG00000198910|ENSG00000106341|ENSG00000165164|ENSG00000148798|ENSG00000157064|ENSG00000078900|ENSG00000163251|ENSG00000139352|ENSG00000168675|ENSG00000124762|ENSG00000125966|ENSG00000183747|ENSG00000158856|ENSG00000136367|ENSG00000075399|ENSG00000129990|ENSG00000163888|ENSG00000065320|ENSG00000182809|ENSG00000079432|ENSG00000149972|ENSG00000198400|ENSG00000135750|ENSG00000154736|ENSG00000076826|ENSG00000259663|ENSG00000148400|ENSG00000177098|ENSG00000168000|ENSG00000135127|ENSG00000145423|ENSG00000102109|ENSG00000160360|ENSG00000166596|ENSG00000221890|ENSG00000184009|ENSG00000014216|ENSG00000134569|ENSG00000167654|ENSG00000132718|ENSG00000129757|ENSG00000235655|ENSG00000118495|ENSG00000154928|ENSG00000137166|ENSG00000173898|ENSG00000165309|ENSG00000164756|ENSG00000142235|ENSG00000058056|ENSG00000139970|ENSG00000257921|ENSG00000177283|ENSG00000169918|ENSG00000102195|ENSG00000150361|ENSG00000186868|ENSG00000180176|ENSG00000198720|ENSG00000205835|ENSG00000183644|ENSG00000270885|ENSG00000213390|ENSG00000144583|ENSG00000168348|ENSG00000183850|ENSG00000177706|ENSG00000115266|ENSG00000231764|ENSG00000248540|ENSG00000137267|ENSG00000177511|ENSG00000135596|ENSG00000115468|ENSG00000204248|ENSG00000171608|ENSG00000167619|ENSG00000105880|ENSG00000120889|ENSG00000042286|ENSG00000168843|ENSG00000166924|ENSG00000136750|ENSG00000174943|ENSG00000108231|ENSG00000108309|ENSG00000180447|ENSG00000197444|ENSG00000182103|ENSG00000136531|ENSG00000259673|ENSG00000129654|ENSG00000008300|ENSG00000077080|ENSG00000110148|ENSG00000101438|ENSG00000167858|ENSG00000226702|ENSG00000166257|ENSG00000148541|ENSG00000152954|ENSG00000115507|ENSG00000122483|ENSG00000002330|ENSG00000169679|ENSG00000174938|ENSG00000120457|ENSG00000250208|ENSG00000148408|ENSG00000135454|ENSG00000280660|ENSG00000105409|ENSG00000142611|ENSG00000185745|ENSG00000167702|ENSG00000105520|ENSG00000105963|ENSG00000258947|ENSG00000236609|ENSG00000103647|ENSG00000132879|ENSG00000005884|ENSG00000167100|ENSG00000205593|ENSG00000026103|ENSG00000078596|ENSG00000151572|ENSG00000087510|ENSG00000104112|ENSG00000181790|ENSG00000184545|ENSG00000197355|ENSG00000099625|ENSG00000140323|ENSG00000049246|ENSG00000163885|ENSG00000079689|ENSG00000054356|ENSG00000130477|ENSG00000127585|ENSG00000136099|ENSG00000107281|ENSG00000189292|ENSG00000121753|ENSG00000187164|ENSG00000272636|ENSG00000187243|ENSG00000152977|ENSG00000064547|ENSG00000224165|ENSG00000070193|ENSG00000115474|ENSG00000162630|ENSG00000139890|ENSG00000092051|ENSG00000166111|ENSG00000137959|ENSG00000152207|ENSG00000157856|ENSG00000008735|ENSG00000162951|ENSG00000181291|ENSG00000167971|ENSG00000163285|ENSG00000153822|ENSG00000082014|ENSG00000149582|ENSG00000254221|ENSG00000164061|ENSG00000163535|ENSG00000179364|ENSG00000235890|ENSG00000151117|ENSG00000196358|ENSG00000172575|ENSG00000064687|ENSG00000130590|ENSG00000116983|ENSG00000101489|ENSG00000265763|ENSG00000284874|ENSG00000179832|ENSG00000250510|ENSG00000155980|ENSG00000066279|ENSG00000170396|ENSG00000085552|ENSG00000135549|ENSG00000059915|ENSG00000005882|ENSG00000152137|ENSG00000206579|ENSG00000138622|ENSG00000069702|ENSG00000136231|ENSG00000016082|ENSG00000242802|ENSG00000177614|ENSG00000130772|ENSG00000174792|ENSG00000178177|ENSG00000151640|ENSG00000258986|ENSG00000178171|ENSG00000145708|ENSG00000167861|ENSG00000233608|ENSG00000070047|ENSG00000197961|ENSG00000106683|ENSG00000186529|ENSG00000171587|ENSG00000182621|ENSG00000143630|ENSG00000166845|ENSG00000196361|ENSG00000159720|ENSG00000104412|ENSG00000177181|ENSG00000197457|ENSG00000035862|ENSG00000243207|ENSG00000228526|ENSG00000171045|ENSG00000173567|ENSG00000145248|ENSG00000082438|ENSG00000197530|ENSG00000126787|ENSG00000197943|ENSG00000185033|ENSG00000277363|ENSG00000073910|ENSG00000138834|ENSG00000145416|ENSG00000173599|ENSG00000127419|ENSG00000126351|ENSG00000171224|ENSG00000141570|ENSG00000212864|ENSG00000225156|ENSG00000131409|ENSG00000114346|ENSG00000132334|ENSG00000099864|ENSG00000160753|ENSG00000213145|ENSG00000137142|ENSG00000100994|ENSG00000129038|ENSG00000144355|ENSG00000174521|ENSG00000120875|ENSG00000196700|ENSG00000055813|ENSG00000138119|ENSG00000283378|ENSG00000171488|ENSG00000173546|ENSG00000163661|ENSG00000105808|ENSG00000079102|ENSG00000183248|ENSG00000090539|ENSG00000135472|ENSG00000181218|ENSG00000172380|ENSG00000250420|ENSG00000079931|ENSG00000198743|ENSG00000093010|ENSG00000131242'  > data/gtf/results_based_on_gene_name.txt


cat data/gtf/results_based_on_gene_name.txt | awk 'BEGIN{FS="\t"}{split($9,a,";"); if($3~"gene") print a[1]"\t"a[3]"\t"$1":"$4"-"$5"\t"a[2]"\t"$7}' |sed 's/gene_id "//' | sed 's/gene_id "//' | sed 's/gene_type "//'| sed 's/gene_name "//' | sed 's/"//g' | awk 'BEGIN{FS="\t"}{split($3,a,"[:-]"); print $1"\t"$2"\t"a[1]"\t"a[2]"\t"a[3]"\t"$4"\t"$5"\t"a[3]-a[2];}' | sed "1i\Geneid\tGeneSymbol\tChromosome\tStart\tEnd\tClass\tStrand\tLength"  > data/gtf/extracted_locations.txt

#+END_SRC


Then we use R to create the actual bedfiles

#+BEGIN_SRC 
library(tidyverse)
# Load the data
dat   <- read_delim("~/Desktop/extracted_locations.txt", delim = "\t")

# Load the significant gene list
rna_dat       <- read_csv("~/Desktop/gene_id_NPC.csv")
upregulated   <- rna_dat[which(rna_dat$log2FoldChange > 0),"Gene"]
downregulated <- rna_dat[which(rna_dat$log2FoldChange < 0),"Gene"]
  
unlist(lapply(dat$Geneid, function(x) str_split(x, "\\.")[[1]][1]))

# Bedfile for upregulated genes
dat %>%
  filter(Geneid %in% unlist(upregulated)) %>%
  select(Chromosome, Start, End, Strand) %>%
  mutate(motif_start = ifelse(Strand %in% "+", (Start - 500), End)) %>%
  mutate(motif_end = ifelse(Strand %in% "+", Start, (End + 500))) %>%
  select(Chromosome, motif_start, motif_end, Strand) -> UpBed

# Bedfile for downregulated genes
dat %>%
  filter(Geneid %in% unlist(downregulated)) %>%
  select(Chromosome, Start, End, Strand) %>%
  mutate(motif_start = ifelse(Strand %in% "+", (Start - 500), End)) %>%
  mutate(motif_end = ifelse(Strand %in% "+", Start, (End + 500))) %>%
  select(Chromosome, motif_start, motif_end, Strand) -> DownBed

write_delim(UpBed, "../data/Upregulated_500bp.bed", delim = "\t", col_names=F)
write_delim(DownBed, "../data/Downregulated_500bp.bed", delim = "\t", col_names=F)
#+END_SRC

*** Extract gene coordinates from reference genome file

#+BEGIN_SRC 
bedtools sort -i Downregulated_500bp.bed > Downregulated_500bp_sorted.bed
bedtools sort -i Upregulated_500bp.bed > Upregulated_500bp_sorted.bed


bedtools getfasta -fi /data/scratch/Seb/GRCh38.primary_assembly.genome.fa  \
    -bed Upregulated_500bp_sorted.bed \
    -s \
    -name \
    -fo Upregulated_500.fa.out

bedtools getfasta -fi /data/scratch/Seb/GRCh38.primary_assembly.genome.fa  \
    -bed Downregulated_500bp_sorted.bed \
    -s \
    -name \
    -fo Downregulated_500.fa.out

#+END_SRC

*** Meme: identify enriched motifs

#+BEGIN_SRC 

#+END_SRC
